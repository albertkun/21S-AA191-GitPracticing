<html>

<head>
    <title>CARTO storytelling with scrollama.js</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <!-- Include Carto.js -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/carto.js/v4.0.0-beta.4/carto.min.js"></script>
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.min.js"></script>
    <script src='https://unpkg.com/scrollama'></script>
    <style>
        body{
            background-color: black;
            color: blanchedalmond;
        }
        #scroll {
            position: relative;
        }

        .scroll__graphic {
            position: absolute;
            top: 0;
            left: 0;
            bottom: auto;
            width: 100%;
            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);

        }

        .scroll__graphic.is-fixed {
            position: fixed;
        }

        .scroll__graphic.is-bottom {
            bottom: 0;
            top: auto;
        }

        .scroll__graphic .chart {
            position: absolute;
            right: 1rem;
            top: 50%;
            -moz-transform: translateY(-50%);
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
        }

        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .scroll__text {
            padding: 0 1rem;
            max-width: 30rem;
        }

        .step {
            margin: 2rem auto;
            border: 1px solid rgb(167, 164, 164);
        }

        .step.is-active {
            background-color: rgb(61, 61, 29);
        }
    </style>
</head>

<body>
    <p>Using
        <a href="https://github.com/russellgoldenberg/scrollama">Scrollama library</a> to create a storytelling map with CARTO.js v4. Scroll down to see how it works</p>
    <section id='scroll'>
        <!--  graphic container  -->
        <div class='scroll__graphic'>
            <!--   actual graphic/chart   -->
            <div class="chart" id='map'></div>
        </div>

        <!--  step/text container  -->
        <div class='scroll__text'>
            <div class='step' data-step='1' data-lon='-3' data-lat='40' data-zoom='3'>
                <h1>Spain, France and Portugal</h1>
                <p>
                    The points on the right side of the screen are the most populated cities of these 3 countries
                </p>
            </div>
            <div class='step' data-step='2' data-lon='-3.68335169' data-lat='40.40002626' data-zoom='4'>
                <h1>Spain</h1>
                <p>
                    <a href="https://en.wikipedia.org/wiki/Spain">Source Wikipedia</a>
                </p>

                <p>
                    Spain (Spanish: España [esˈpaɲa] (About this sound listen)), officially the Kingdom of Spain (Spanish: Reino de España),[a][b]
                    is a sovereign state located on the Iberian Peninsula in southwestern Europe, with two large archipelagoes,
                    the Balearic Islands in the Mediterranean Sea and the Canary Islands off the North African Atlantic coast,
                    two cities, Ceuta and Melilla, in the North African mainland and several small islands in the Alboran
                    Sea near the Moroccan coast. The country's mainland is bordered to the south and east by the Mediterranean
                    Sea except for a small land boundary with Gibraltar; to the north and northeast by France, Andorra, and
                    the Bay of Biscay; and to the west and northwest by Portugal and the Atlantic Ocean. It is the only European
                    country to have a border with an African country (Morocco)[h] and its African territory accounts for
                    nearly 5% of its population, mostly in the Canary Islands but also in Ceuta and Melilla.
                </p>
            </div>
            <div class='step' data-step='3' data-lon='2.39999792' data-lat='47.08372683' data-zoom='4'>
                <h1>France</h1>
                <p>
                    <a href="https://en.wikipedia.org/wiki/France">Source Wikipedia</a>
                </p>
                <p>
                    France (French IPA: [fʁɑ̃s]), officially the French Republic (French: République française [ʁepyblik fʁɑ̃sɛz]), is a country
                    whose territory consists of metropolitan France in western Europe, as well as several overseas regions
                    and territories.[XIII] The metropolitan area of France extends from the Mediterranean Sea to the English
                    Channel and the North Sea, and from the Rhine to the Atlantic Ocean. The overseas territories include
                    French Guiana in South America and several islands in the Atlantic, Pacific and Indian oceans. The country's
                    18 integral regions (5 of which are situated overseas) span a combined area of 643,801 square kilometres
                    (248,573 sq mi) which, as of October 2017, has a population of 67.15 million people.[10] France is a
                    unitary semi-presidential republic with its capital in Paris, the country's largest city and main cultural
                    and commercial centre. Other major urban centres include Marseille, Lyon, Lille, Nice, Toulouse and Bordeaux.
                </p>
            </div>
            <div class='step' data-step='4' data-lon='-8.90001001' data-lat='38.52995953' data-zoom='5'>
                <h1>Portugal</h1>
                <p>
                    <a href="https://en.wikipedia.org/wiki/Portugal">Source Wikipedia</a>
                </p>
                <p>
                    Portugal (Portuguese: [puɾtuˈɣaɫ]), officially the Portuguese Republic (Portuguese: República Portuguesa [ʁɛ'puβlikɐ puɾtu'ɣezɐ]),[note
                    1] is a sovereign state located on the Iberian Peninsula in southwestern Europe. It is the westernmost
                    country of mainland Europe, being bordered to the west and south by the Atlantic Ocean and to the north
                    and east by Spain. Its territory also includes the Atlantic archipelagos of the Azores and Madeira, both
                    autonomous regions with their own regional governments. At 1.7 million km2, its Exclusive Economic Zone
                    is the 3rd largest in the European Union and the 11th largest in the world.
                </p>

            </div>
        </div>
    </section>
    <script>

        // using d3 for convenience, and storing a selected elements
        let container = d3.select('#scroll');
        let graphic = container.select('.scroll__graphic');
        let chart = graphic.select('.chart');
        let text = container.select('.scroll__text');
        let step = text.selectAll('.step');
        let map;
        let client;
        let source;
        let style;
        let Cartolayer;



        // initialize the scrollama
        let scroller = scrollama();

        // resize function to set dimensions on load and on page resize
        function handleResize() {
            // 1. update height of step elements for breathing room between steps
            let stepHeight = Math.floor(window.innerHeight * 0.75);
            step.style('height', stepHeight + 'px');

            // 2. update height of graphic element
            let bodyWidth = d3.select('body').node().offsetWidth;

            graphic
                .style('height', window.innerHeight + 'px');

            // 3. update width of chart by subtracting from text width
            let chartMargin = 10;
            let textWidth = text.node().offsetWidth;
            let chartWidth = graphic.node().offsetWidth - textWidth - chartMargin;
            // make the height 1/2 of viewport
            let chartHeight = 80;

            chart
                .style('width', chartWidth + 'px')
                .style('height', chartHeight + '%');

            // 4. tell scrollama to update new element dimensions
            scroller.resize();
        }

        // scrollama event handlers
        function handleStepEnter(response) {
            // response = { element, direction, index }

            // fade in current step
            step.classed('is-active', function (d, i) {
                return i === response.index;
            })

            // get attributes from element with "is-active" class
            let stepClass = document.getElementsByClassName('is-active')[0]

            let lon = stepClass.getAttribute('data-lon')
            let lat = stepClass.getAttribute('data-lat')
            let zoom = stepClass.getAttribute('data-zoom')

            // change map position and zoom level depending on data-lon, data-lat and data-zoom attribute values
            map.flyTo([lat, lon], zoom)

            // change with SQL the source of the layer
            if (response.index === 0) {
                source.setQuery(`
                SELECT * FROM populated_places_spf
                `)
            } else if (response.index === 1) {
                source.setQuery(`
                SELECT * FROM populated_places_spf WHERE adm0name = \'Spain\'
                `)
            }
            else if (response.index === 2) {
                source.setQuery(`
                SELECT * FROM populated_places_spf WHERE adm0name = \'France\'
                `)
            }
            else if (response.index === 3) {
                source.setQuery(`
                SELECT * FROM populated_places_spf WHERE adm0name = \'Portugal\'
                `)
            }

        }

        function handleContainerEnter(response) {
            // response = { direction }

            // sticky the graphic
            graphic.classed('is-fixed', true);
            graphic.classed('is-bottom', false);
        }

        function handleContainerExit(response) {
            // response = { direction }

            // un-sticky the graphic, and pin to top/bottom of container
            graphic.classed('is-fixed', false);
            graphic.classed('is-bottom', response.direction === 'down');
        }

        // kick-off code to run once on load
        function init() {
            // 1. call a resize on load to update width/height/position of elements
            handleResize();


            // 2. setup the scrollama instance
            // 3. bind scrollama event handlers (this can be chained like below)
            scroller
                .setup({
                    container: '#scroll', // our outermost scrollytelling element
                    graphic: '.scroll__graphic', // the graphic
                    text: '.scroll__text', // the step container
                    step: '.scroll__text .step', // the step elements
                    offset: 0.25, // set the trigger to be 0.25 way down screen
                    debug: false, // not display the trigger offset for testing
                })
                .onStepEnter(handleStepEnter)
                .onContainerEnter(handleContainerEnter)
                .onContainerExit(handleContainerExit);

            // setup resize event
            window.addEventListener('resize', handleResize);
            cartoMap();


        }

        function cartoMap() {
            /*
                Set CARTO map
            */

            map = L.map('map').setView([30, 0], 3);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
                maxZoom: 18
            }).addTo(map);

            // define client
            client = new carto.Client({
                apiKey: 'default_public',
                username: 'oboix'
            });
            // define source of data using a SQL query
            source = new carto.source.SQL(`
                SELECT * FROM populated_places_spf
            `);
            // define CartoCSS code to style data on map
            style = new carto.style.CartoCSS(`
                #layer[adm0name = "Spain"]{
                    marker-fill: #fbb4ae;
                    marker-allow-overlap: true;
                }
                #layer[adm0name = "Portugal"]{
                    marker-fill: #ccebc5;
                    marker-allow-overlap: true;
                }
                #layer[adm0name = "France"]{
                    marker-fill: #b3cde3;
                    marker-allow-overlap: true;
                }`
            );
            // create CARTO layer from source and style variables
            Cartolayer = new carto.layer.Layer(source, style);

            // add CARTO layer to the client
            client.addLayer(Cartolayer);

            // get tile from client and add them to the map object
            client.getLeafletLayer().addTo(map);
        }

        // start it up
        init();
    </script>
</body>

</html>